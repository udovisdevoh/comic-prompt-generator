<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Prompts BD IA</title>
    <style>
        body {
            font-family: sans-serif;
            line-height: 1.6;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1, h2, h3, h4 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        h3.mode-title {
            border-bottom-style: dashed;
            color: #0056b3;
        }
        h4 { 
            border-bottom-style: solid;
            border-bottom-width: 1px;
            border-color: #007bff;
            padding-bottom: 8px;
            margin-top: 25px;
            font-size: 1.2em;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            margin-right: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .button-secondary {
            background-color: #6c757d;
        }
        .button-secondary:hover {
            background-color: #545b62;
        }
        .button-tertiary { 
            background-color: #28a745; 
        }
        .button-tertiary:hover {
            background-color: #1e7e34;
        }
        .step-section, .mode-section {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .page-generation-block { 
            border: 1px solid #ccc;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
            background-color: #fdfdfd;
        }
        .storyboard-page-section { 
            margin-top:15px;
            padding-top:15px;
            border-top: 1px dashed #007bff;
        }
        #toast-notification {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center;
            border-radius: 4px; padding: 16px; position: fixed; z-index: 1000; left: 50%;
            transform: translateX(-50%); bottom: 30px; font-size: 17px; opacity: 0;
            transition: opacity 0.5s, bottom 0.5s, visibility 0.5s;
        }
        #toast-notification.show { visibility: visible; opacity: 1; bottom: 50px; }
        .hidden { display: none !important; } 
        .mode-selector { margin-bottom: 20px; padding: 10px; background-color: #ddeeff; border-radius: 5px;}
        .mode-selector label { margin-right: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Générateur de Prompts BD IA</h1>

        <div class="mode-selector">
            <h3>Choisir le mode de génération de texte :</h3>
            <label><input type="radio" name="generationMode" value="stepByStep" checked> Mode par Étapes (inclut Storyboard par page)</label>
            <label><input type="radio" name="generationMode" value="singleBlock"> Mode Monobloc (Texte intégral)</label>
        </div>

        <div class="step-section" id="parametersSection">
            <h2>Paramètres Généraux de l'Oeuvre</h2>
            <label for="presetSelect">Choisir un preset :</label>
            <select id="presetSelect">
                <option value="">-- Manuel --</option>
            </select>
            <label for="nomBd">Nom de la série / type d'oeuvre :</label>
            <input type="text" id="nomBd" value="Mon Gag">
            <label for="totalPages">Pages/Strips au total (base) :</label>
            <input type="number" id="totalPages" value="2">
            <label for="pageVariation">Variation de pages/strips (+/-) :</label>
            <input type="number" id="pageVariation" value="0">
            <label for="panelsPerPage">Cases par page/strip (moyenne) :</label>
            <input type="number" id="panelsPerPage" value="6">
            <label for="bubblesPerPage">Bulles par page/strip (moyenne) :</label>
            <input type="number" id="bubblesPerPage" value="5">
            <label for="wordsPerPage">Mots par page/strip (moyenne) :</label>
            <input type="number" id="wordsPerPage" value="30">
            <label for="yellowBlocksPerPage">Blocs narratifs par page/strip (moyenne) :</label>
            <input type="number" id="yellowBlocksPerPage" value="0">
        </div>

        <div id="stepByStepModeContainer">
            <h3 class="mode-title">Mode par Étapes</h3>
            <div class="step-section">
                <h2>Étape 1 : Définition de l'Oeuvre</h2>
                <button id="generateStep1Prompt">Générer Prompt Étape 1</button>
                <label for="step1PromptOutput">Prompt pour l'IA (Étape 1) :</label>
                <textarea id="step1PromptOutput" readonly></textarea>
                <button id="copyStep1Prompt" class="button-secondary">Copier Prompt Étape 1</button>
                <label for="step1AiResponse">Coller le résultat de l'IA (Titre, Résumé, Personnages, Ton) :</label>
                <textarea id="step1AiResponse"></textarea>
            </div>

            <div class="step-section">
                <h2>Étape 2 : Structure des Pages/Strips</h2>
                <button id="generateStep2Prompt">Générer Prompt Étape 2</button>
                <label for="step2PromptOutput">Prompt pour l'IA (Étape 2) :</label>
                <textarea id="step2PromptOutput" readonly></textarea>
                <button id="copyStep2Prompt" class="button-secondary">Copier Prompt Étape 2</button>
                <label for="step2AiResponse">Coller le résultat de l'IA (Descriptions sommaires) :</label>
                <textarea id="step2AiResponse"></textarea>
            </div>

            <div class="step-section">
                <h2>Étape 3 : Génération Détaillée & Storyboard par Page/Strip</h2>
                <button id="setupStep3Fields">Préparer les champs pour l'Étape 3</button>
                <div id="step3PagePromptsContainer"></div>
            </div>

            <div class="step-section">
                <h2>Étape 4 : Compilation Textuelle Finale (Optionnel)</h2>
                <p>Compile tout le contenu textuel des étapes précédentes.</p>
                <button id="compileAllContent">Compiler Tout le Contenu Textuel</button>
                <label for="finalCompilationOutput">Compilation Textuelle Finale :</label>
                <textarea id="finalCompilationOutput" readonly style="min-height: 300px;"></textarea>
                <button id="copyFinalCompilation" class="button-secondary">Copier la Compilation</button>
            </div>
        </div>

        <div id="singleBlockTextModeContainer" class="mode-section hidden">
            <h3 class="mode-title">Mode Monobloc (Sortie Texte Intégral)</h3>
            <p>Génère un prompt unique pour obtenir toute la description textuelle de l'oeuvre par l'IA.</p>
            <button id="generateSingleBlockTextPrompt">Générer Prompt Monobloc (Texte)</button>
            <label for="singleBlockTextPromptOutput">Prompt Monobloc pour l'IA :</label>
            <textarea id="singleBlockTextPromptOutput" readonly style="min-height: 200px;"></textarea>
            <button id="copySingleBlockTextPrompt" class="button-secondary">Copier Prompt Monobloc</button>
            <hr style="margin: 20px 0;">
            <label for="singleBlockAiTextOutput">Coller la réponse textuelle complète de l'IA ici :</label>
            <textarea id="singleBlockAiTextOutput" style="min-height: 250px;"></textarea>
            
            <div id="singlePageStoryboardFromMonoblocSection" class="hidden storyboard-page-section">
                 <h4>Storyboard pour sortie Monobloc (si 1 page/strip)</h4>
                 <button id="generateSinglePageStoryboardPromptFromMonoblocBtn" class="button-tertiary">Générer Prompt Storyboard pour cette Unité</button>
                 <label for="singlePageStoryboardConversionPromptOutput">Prompt Storyboard (depuis sortie monobloc) :</label>
                 <textarea id="singlePageStoryboardConversionPromptOutput" readonly></textarea>
                 <button id="copySinglePageStoryboardConversionPromptBtn" class="button-secondary">Copier Prompt Storyboard</button>
                 <label for="singlePageStoryboardAiHtmlOutput">Coller le code HTML/SVG ici :</label>
                 <textarea id="singlePageStoryboardAiHtmlOutput" style="font-family: monospace;"></textarea>
                 </div>
        </div>
    </div>

    <div id="toast-notification"></div>

    <script>
        const presets = { // Assurez-vous que cet objet est à jour avec tous vos presets
            achiletalon:    { nomBd: "Achille Talon (gag 2p.)",                totalPages: 2,  pageVariation: 0,  panelsPerPage: 12, bubblesPerPage: 18, wordsPerPage: 220, yellowBlocksPerPage: 1 },
            asterix:        { nomBd: "Astérix",                                totalPages: 42, pageVariation: 0,  panelsPerPage: 9,  bubblesPerPage: 13, wordsPerPage: 116, yellowBlocksPerPage: 1 },
            astroboy:       { nomBd: "Astro Boy (chapitre aventure)",          totalPages: 24, pageVariation: 4,  panelsPerPage: 6,  bubblesPerPage: 7,  wordsPerPage: 80,  yellowBlocksPerPage: 1 }, 
            attackontitan:  { nomBd: "Attack on Titan (chapitre)",             totalPages: 40, pageVariation: 5,  panelsPerPage: 5,  bubblesPerPage: 6,  wordsPerPage: 70,  yellowBlocksPerPage: 1 }, 
            berserk:        { nomBd: "Berserk (chapitre)",                     totalPages: 22, pageVariation: 4,  panelsPerPage: 5,  bubblesPerPage: 5,  wordsPerPage: 60,  yellowBlocksPerPage: 1 }, 
            blakemortimer:  { nomBd: "Blake et Mortimer",                      totalPages: 56, pageVariation: 2,  panelsPerPage: 10, bubblesPerPage: 12, wordsPerPage: 280, yellowBlocksPerPage: 2 },
            bouleetbill:    { nomBd: "Boule et Bill (gag 1p.)",                totalPages: 1,  pageVariation: 0,  panelsPerPage: 6,  bubblesPerPage: 6,  wordsPerPage: 45,  yellowBlocksPerPage: 0 },
            deathnote:      { nomBd: "Death Note (chapitre)",                  totalPages: 19, pageVariation: 1,  panelsPerPage: 7,  bubblesPerPage: 9,  wordsPerPage: 110, yellowBlocksPerPage: 1 }, 
            dragonball:     { nomBd: "Dragon Ball (Goku enfant - Arc ~100p.)",  totalPages: 100,pageVariation: 4,  panelsPerPage: 6,  bubblesPerPage: 7,  wordsPerPage: 80,  yellowBlocksPerPage: 1 },
            dragonballz:    { nomBd: "Dragon Ball Z (Goku adulte - Arc ~100p.)",totalPages: 100,pageVariation: 4,  panelsPerPage: 6,  bubblesPerPage: 7,  wordsPerPage: 75,  yellowBlocksPerPage: 1 },
            drslump:        { nomBd: "Dr. Slump (chapitre gag)",               totalPages: 14, pageVariation: 1,  panelsPerPage: 7,  bubblesPerPage: 8,  wordsPerPage: 90,  yellowBlocksPerPage: 1 }, 
            garfield:       { nomBd: "Garfield (gag-strip)",                   totalPages: 1,  pageVariation: 0,  panelsPerPage: 3,  bubblesPerPage: 3,  wordsPerPage: 20,  yellowBlocksPerPage: 0 }, 
            gastonlagaffe:  { nomBd: "Gaston Lagaffe (gag 1p.)",               totalPages: 1,  pageVariation: 0,  panelsPerPage: 9,  bubblesPerPage: 9,  wordsPerPage: 60,  yellowBlocksPerPage: 0 },
            iznogoud:       { nomBd: "Iznogoud (1 histoire)",                  totalPages: 10, pageVariation: 2,  panelsPerPage: 9,  bubblesPerPage: 13, wordsPerPage: 115, yellowBlocksPerPage: 1 },
            joebarteam:     { nomBd: "Joe Bar Team (gag 1p.)",                 totalPages: 1,  pageVariation: 0,  panelsPerPage: 8,  bubblesPerPage: 8,  wordsPerPage: 80,  yellowBlocksPerPage: 0 },
            jozettejocko:   { nomBd: "Jo, Zette et Jocko",                     totalPages: 52, pageVariation: 0,  panelsPerPage: 9,  bubblesPerPage: 12, wordsPerPage: 130, yellowBlocksPerPage: 1 },
            luckyluke:      { nomBd: "Lucky Luke",                             totalPages: 44, pageVariation: 0,  panelsPerPage: 9,  bubblesPerPage: 13, wordsPerPage: 120, yellowBlocksPerPage: 1 },
            marsupilami:    { nomBd: "Marsupilami (aventure)",                 totalPages: 46, pageVariation: 0,  panelsPerPage: 8,  bubblesPerPage: 9,  wordsPerPage: 90,  yellowBlocksPerPage: 1 },
            naruto:         { nomBd: "Naruto (chapitre)",                      totalPages: 18, pageVariation: 2,  panelsPerPage: 6,  bubblesPerPage: 7,  wordsPerPage: 80,  yellowBlocksPerPage: 1 }, 
            onepiece:       { nomBd: "One Piece (chapitre)",                   totalPages: 17, pageVariation: 2,  panelsPerPage: 6,  bubblesPerPage: 8,  wordsPerPage: 90,  yellowBlocksPerPage: 1 }, 
            oumpahpah:      { nomBd: "Oumpah-Pah (1 histoire)",                totalPages: 30, pageVariation: 2,  panelsPerPage: 9,  bubblesPerPage: 11, wordsPerPage: 110, yellowBlocksPerPage: 1 },
            peanuts:        { nomBd: "Peanuts (gag-strip)",                    totalPages: 1,  pageVariation: 0,  panelsPerPage: 4,  bubblesPerPage: 4,  wordsPerPage: 30,  yellowBlocksPerPage: 0 }, 
            philemon:       { nomBd: "Philémon (aventure onirique)",           totalPages: 44, pageVariation: 2,  panelsPerPage: 7,  bubblesPerPage: 11, wordsPerPage: 110, yellowBlocksPerPage: 1 },
            pierrafeuquebec:{ nomBd: "Les Pierrafeu (BD québécoise)",          totalPages: 12, pageVariation: 2,  panelsPerPage: 6,  bubblesPerPage: 7,  wordsPerPage: 90,  yellowBlocksPerPage: 1 },
            petitspirougag: { nomBd: "Le Petit Spirou (gag)",                  totalPages: 1,  pageVariation: 0,  panelsPerPage: 9,  bubblesPerPage: 9,  wordsPerPage: 60,  yellowBlocksPerPage: 0 },
            petitspirouhist:{ nomBd: "Le Petit Spirou (hist. 6p.)",            totalPages: 6,  pageVariation: 0,  panelsPerPage: 9,  bubblesPerPage: 10, wordsPerPage: 70,  yellowBlocksPerPage: 0 },
            quickflupke:    { nomBd: "Quick et Flupke (gag)",                  totalPages: 2,  pageVariation: 0,  panelsPerPage: 6,  bubblesPerPage: 5,  wordsPerPage: 30,  yellowBlocksPerPage: 0 },
            schtroumpfs:    { nomBd: "Les Schtroumpfs (1 histoire)",           totalPages: 29, pageVariation: 10, panelsPerPage: 10, bubblesPerPage: 13, wordsPerPage: 100, yellowBlocksPerPage: 1 },
            simpsonquebec:  { nomBd: "Les Simpson (BD québécoise)",            totalPages: 22, pageVariation: 2,  panelsPerPage: 6,  bubblesPerPage: 8,  wordsPerPage: 110, yellowBlocksPerPage: 1 },
            spirou:         { nomBd: "Spirou et Fantasio",                     totalPages: 58, pageVariation: 0,  panelsPerPage: 9,  bubblesPerPage: 14, wordsPerPage: 130, yellowBlocksPerPage: 1 },
            spyxfamily:     { nomBd: "Spy x Family (chapitre/mission)",        totalPages: 25, pageVariation: 5,  panelsPerPage: 6,  bubblesPerPage: 8,  wordsPerPage: 90,  yellowBlocksPerPage: 1 }, 
            tintin:         { nomBd: "Tintin",                                 totalPages: 62, pageVariation: 0,  panelsPerPage: 9,  bubblesPerPage: 13, wordsPerPage: 140, yellowBlocksPerPage: 1 },
            yakari:         { nomBd: "Yakari (aventure jeunesse)",             totalPages: 44, pageVariation: 0,  panelsPerPage: 8,  bubblesPerPage: 9,  wordsPerPage: 80,  yellowBlocksPerPage: 1 },
            yokotsuno:      { nomBd: "Yoko Tsuno",                             totalPages: 44, pageVariation: 0,  panelsPerPage: 9,  bubblesPerPage: 11, wordsPerPage: 130, yellowBlocksPerPage: 1 }
        };

        // DOM Elements
        const presetSelect = document.getElementById('presetSelect');
        const nomBdInput = document.getElementById('nomBd');
        const totalPagesInput = document.getElementById('totalPages');
        const pageVariationInput = document.getElementById('pageVariation');
        const panelsPerPageInput = document.getElementById('panelsPerPage');
        const bubblesPerPageInput = document.getElementById('bubblesPerPage');
        const wordsPerPageInput = document.getElementById('wordsPerPage');
        const yellowBlocksPerPageInput = document.getElementById('yellowBlocksPerPage');

        // Step-by-step mode elements
        const generateStep1PromptBtn = document.getElementById('generateStep1Prompt');
        const step1PromptOutput = document.getElementById('step1PromptOutput');
        const copyStep1PromptBtn = document.getElementById('copyStep1Prompt');
        const step1AiResponse = document.getElementById('step1AiResponse');
        const generateStep2PromptBtn = document.getElementById('generateStep2Prompt');
        const step2PromptOutput = document.getElementById('step2PromptOutput');
        const copyStep2PromptBtn = document.getElementById('copyStep2Prompt');
        const step2AiResponse = document.getElementById('step2AiResponse');
        const setupStep3FieldsBtn = document.getElementById('setupStep3Fields');
        const step3PagePromptsContainer = document.getElementById('step3PagePromptsContainer');
        const compileAllContentBtn = document.getElementById('compileAllContent');
        const finalCompilationOutput = document.getElementById('finalCompilationOutput'); 
        const copyFinalCompilationBtn = document.getElementById('copyFinalCompilation');
        
        const toastNotification = document.getElementById('toast-notification');
        let toastTimeout;

        // Mode Management Elements
        const modeRadios = document.querySelectorAll('input[name="generationMode"]');
        const stepByStepModeContainer = document.getElementById('stepByStepModeContainer');
        const singleBlockTextModeContainer = document.getElementById('singleBlockTextModeContainer'); 

        // Mode Monobloc (Texte) Elements
        const generateSingleBlockTextPromptBtn = document.getElementById('generateSingleBlockTextPrompt');
        const singleBlockTextPromptOutput = document.getElementById('singleBlockTextPromptOutput');
        const copySingleBlockTextPromptBtn = document.getElementById('copySingleBlockTextPrompt');
        const singleBlockAiTextOutput = document.getElementById('singleBlockAiTextOutput');
        
        // Elements pour le storyboard de page unique depuis le mode monobloc
        const singlePageStoryboardFromMonoblocSection = document.getElementById('singlePageStoryboardFromMonoblocSection');
        const generateSinglePageStoryboardPromptFromMonoblocBtn = document.getElementById('generateSinglePageStoryboardPromptFromMonoblocBtn');
        const singlePageStoryboardConversionPromptOutput = document.getElementById('singlePageStoryboardConversionPromptOutput');
        const copySinglePageStoryboardConversionPromptBtn = document.getElementById('copySinglePageStoryboardConversionPromptBtn');
        const singlePageStoryboardAiHtmlOutput = document.getElementById('singlePageStoryboardAiHtmlOutput');


        function switchMode(mode) {
            stepByStepModeContainer.classList.add('hidden');
            singleBlockTextModeContainer.classList.add('hidden');

            if (mode === 'stepByStep') {
                stepByStepModeContainer.classList.remove('hidden');
            } else if (mode === 'singleBlock') {
                singleBlockTextModeContainer.classList.remove('hidden');
                checkShowMonoblocStoryboardOption(); // Vérifier si l'option storyboard doit être montrée
            }
        }

        modeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                switchMode(this.value);
            });
        });
        
        function checkShowMonoblocStoryboardOption() {
            const totalPages = parseInt(totalPagesInput.value, 10);
            if (totalPages === 1 && singleBlockAiTextOutput.value.trim() !== '') {
                singlePageStoryboardFromMonoblocSection.classList.remove('hidden');
            } else {
                singlePageStoryboardFromMonoblocSection.classList.add('hidden');
            }
        }
        
        // Écouteur pour montrer/cacher l'option storyboard du mode monobloc
        totalPagesInput.addEventListener('input', checkShowMonoblocStoryboardOption);
        singleBlockAiTextOutput.addEventListener('input', checkShowMonoblocStoryboardOption);


        function setDefaultParameters() {
            nomBdInput.value = "Mon Gag"; 
            totalPagesInput.value = 2; 
            pageVariationInput.value = 0; 
            panelsPerPageInput.value = 6;
            bubblesPerPageInput.value = 5;
            wordsPerPageInput.value = 30;
            yellowBlocksPerPageInput.value = 0;
            checkShowMonoblocStoryboardOption(); // Mettre à jour la visibilité au reset
        }

        function populatePresetDropdown() {
            const sortedPresets = Object.entries(presets)
                .map(([key, value]) => ({ key: key, displayName: value.nomBd }))
                .sort((a, b) => a.displayName.localeCompare(b.displayName, 'fr', { sensitivity: 'base' }));

            while (presetSelect.options.length > 1) {
                presetSelect.remove(1);
            }

            sortedPresets.forEach(presetInfo => {
                const option = document.createElement('option');
                option.value = presetInfo.key;
                option.textContent = presetInfo.displayName;
                presetSelect.appendChild(option);
            });
        }
        
        presetSelect.addEventListener('change', function() {
            const selectedPresetKey = this.value;
            const selectedPreset = presets[selectedPresetKey];
            if (selectedPreset) {
                nomBdInput.value = selectedPreset.nomBd;
                totalPagesInput.value = selectedPreset.totalPages;
                pageVariationInput.value = selectedPreset.pageVariation; 
                panelsPerPageInput.value = selectedPreset.panelsPerPage;
                bubblesPerPageInput.value = selectedPreset.bubblesPerPage;
                wordsPerPageInput.value = selectedPreset.wordsPerPage;
                yellowBlocksPerPageInput.value = selectedPreset.yellowBlocksPerPage;
            } else {
                setDefaultParameters();
            }
            step3PagePromptsContainer.innerHTML = ''; 
            showToastNotification("Les champs de l'Étape 3 ont été réinitialisés suite au changement de preset/paramètres.");
            checkShowMonoblocStoryboardOption(); // Mettre à jour la visibilité
        });
        
        function showToastNotification(message) {
            if (toastTimeout) clearTimeout(toastTimeout);
            toastNotification.textContent = message;
            toastNotification.className = "show";
            toastTimeout = setTimeout(() => { 
                toastNotification.className = toastNotification.className.replace("show", ""); 
            }, 3000);
        }

        function copyToClipboard(elementIdOrText, isText = false) {
            let textToCopy;
            if (isText) {
                textToCopy = elementIdOrText;
                 if (!textToCopy) { showToastNotification("Rien à copier !"); return; }
            } else {
                const textarea = document.getElementById(elementIdOrText);
                if (!textarea || !textarea.value) { showToastNotification("Rien à copier !"); return; }
                textToCopy = textarea.value;
                textarea.select();
                textarea.setSelectionRange(0, 99999);
            }
            try {
                navigator.clipboard.writeText(textToCopy).then(() => {
                     showToastNotification('Contenu copié dans le presse-papiers !');
                }, () => { document.execCommand('copy'); showToastNotification('Contenu copié (fallback) !'); });
            } catch (err) {
                try { document.execCommand('copy'); showToastNotification('Contenu copié (execCommand fallback) !');}
                catch (e) { showToastNotification('La copie a échoué. Veuillez copier manuellement.'); }
            }
        }
        
        generateStep1PromptBtn.addEventListener('click', function() {
            const nomDeLaBd = nomBdInput.value.trim() || "[Nom de la BD à définir]";
            const currentTotalPages = parseInt(totalPagesInput.value, 10);
            let typeOeuvre = "d'un album"; 

            if (nomDeLaBd.toLowerCase().includes("gag-strip") || (nomDeLaBd.toLowerCase().includes("gag 1p.") && currentTotalPages === 1 && !nomDeLaBd.toLowerCase().includes("petit spirou")) ) { typeOeuvre = "d'un gag (format strip)"; }
            else if (nomDeLaBd.toLowerCase().includes("gag")) { typeOeuvre = "d'un gag"; } 
            else if (nomDeLaBd.toLowerCase().includes("hist.")) { typeOeuvre = "d'une histoire courte"; } 
            else if (nomDeLaBd.toLowerCase().includes("histoire")) { typeOeuvre = "d'une histoire"; } 
            else if (nomDeLaBd.toLowerCase().includes("aventure jeunesse")) { typeOeuvre = "d'une aventure jeunesse"; }
            else if (nomDeLaBd.toLowerCase().includes("aventure")) { typeOeuvre = "d'une aventure"; }
            else if (nomDeLaBd.toLowerCase().includes("(bd québécoise)")) { typeOeuvre = "d'une bande dessinée (style américain, adaptation québécoise)"; } 
            else if (nomDeLaBd.toLowerCase().includes("(chapitre") || nomDeLaBd.toLowerCase().includes("(arc")) { 
                 if (nomDeLaBd.toLowerCase().includes("arc") || (!isNaN(currentTotalPages) && currentTotalPages > 50)) {
                    typeOeuvre = "d'un arc narratif (type manga)";
                } else {
                    typeOeuvre = "d'un chapitre (type manga)";
                }
            }
            step1PromptOutput.value = `Générez-moi le titre ${typeOeuvre} de ${nomDeLaBd}\nainsi qu'un très court résumé de l'intrigue principale (1-2 phrases pour un gag ou strip, 3-5 pour une histoire courte ou un chapitre, potentiellement plus pour un arc narratif ou une aventure complète)\nainsi que la liste des personnages importants et leur rôle\net le ton et le style de l'oeuvre. L'oeuvre doit être originale et ne pas trop ressembler à une oeuvre existante mais respecter le thème de l'univers de ${nomDeLaBd}.`;
        });
        copyStep1PromptBtn.addEventListener('click', () => copyToClipboard('step1PromptOutput'));

        generateStep2PromptBtn.addEventListener('click', function() {
            const titreEtDescription = step1AiResponse.value.trim();
            if (!titreEtDescription) { showToastNotification("Veuillez d'abord coller le résultat de l'IA de l'Étape 1."); return; }
            
            const currentNomBd = nomBdInput.value;
            const totalPages = parseInt(totalPagesInput.value, 10);
            const variation = parseInt(pageVariationInput.value, 10);
            let pageCountDescription = "";
            let unitName = (currentNomBd.toLowerCase().includes("gag-strip") || (currentNomBd.toLowerCase().includes("gag 1p.") && totalPages === 1 && !currentNomBd.toLowerCase().includes("petit spirou")) ) ? "strip" : "page";

            if (isNaN(totalPages) || totalPages <=0) { showToastNotification("Nombre de pages de base invalide."); return; }
            if (isNaN(variation) || variation < 0) { showToastNotification("Variation de page invalide."); return; }

            if (variation === 0) {
                pageCountDescription = `${totalPages} ${unitName}${totalPages > 1 ? 's' : ''} au total (nombre fixe).`;
            } else {
                const minPages = Math.max(1, totalPages - variation);
                const maxPages = totalPages + variation;
                pageCountDescription = `Environ ${totalPages} ${unitName}${totalPages > 1 ? 's' : ''} au total. Le nombre final peut varier de ${minPages} à ${maxPages}.`;
            }

            let endingDescription = "une conclusion satisfaisante (par exemple, la fin d'un arc narratif, la résolution d'un combat important, ou un cliffhanger pour le prochain chapitre/la prochaine histoire).";
            if (currentNomBd.toLowerCase().includes("gag") || totalPages <= 2) { 
                endingDescription = `une "punch line" – un dénouement surprenant, très drôle, et d'une nature délicieusement absurde ou inusitée.`;
            }

            const panelsAvg = panelsPerPageInput.value;
            const bubblesAvg = bubblesPerPageInput.value;
            const wordsAvg = wordsPerPageInput.value;
            const yellowBlocksAvg = yellowBlocksPerPageInput.value;

            const prompt = `Considérant cette oeuvre (album/histoire/gag/strip/chapitre manga/arc manga/aventure) suivante:
--- DÉBUT TITRE ET DESCRIPTION ---
${titreEtDescription}
--- FIN TITRE ET DESCRIPTION ---

Générez-moi une description sommaire de chaque ${unitName} (courte description d'un maximum 3 lignes par ${unitName}).
${pageCountDescription}
Nombre de cases par ${unitName} en moyenne, peut varier : ${panelsAvg}.
Nombre de bulles par ${unitName} en moyenne (peut varier) : ${bubblesAvg}.
Nombre de mots par ${unitName} en moyenne (peut varier) : ${wordsAvg}.
Nombre de blocs de texte (narratif/explicatif) par ${unitName} en moyenne (peut varier) : ${yellowBlocksAvg}. (Si 0, cela signifie sans narration textuelle).

Chaque ${unitName} (si plusieurs) doit avoir un effet intriguant à la fin pour inciter le lecteur à lire la prochaine (si applicable) et cette mini-intrigue sera résolue ensuite. Le/La dernier/dernière ${unitName} doit terminer par ${endingDescription}
Pour chaque ${unitName}, spécifiez le nombre de cases, de bulles, le nombre de mots, et le nombre de blocs de texte.
Pour un manga, n'oubliez pas de penser aux onomatopées et à la dynamique des cases pour les scènes d'action.`;
            step2PromptOutput.value = prompt;
        });
        copyStep2PromptBtn.addEventListener('click', () => copyToClipboard('step2PromptOutput'));

        setupStep3FieldsBtn.addEventListener('click', function() {
            const totalPages = parseInt(totalPagesInput.value, 10);
            const currentNomBd = nomBdInput.value;
            let unitName = (currentNomBd.toLowerCase().includes("gag-strip") || (currentNomBd.toLowerCase().includes("gag 1p.") && totalPages === 1 && !currentNomBd.toLowerCase().includes("petit spirou")) ) ? "Strip" : "Page";

            if (isNaN(totalPages) || totalPages <= 0) { showToastNotification("Veuillez entrer un nombre de pages (base) valide."); return; }
            step3PagePromptsContainer.innerHTML = ''; 
            for (let i = 1; i <= totalPages; i++) {
                const pageBlock = document.createElement('div');
                pageBlock.classList.add('page-generation-block');
                pageBlock.innerHTML = `
                    <h4>${unitName} ${i}</h4>
                    <button id="generateTextPrompt_page_${i}" data-page="${i}">Générer Prompt Texte Détaillé ${unitName} ${i}</button>
                    <label for="step3PagePromptOutput_${i}">Prompt Texte Détaillé pour ${unitName} ${i} :</label>
                    <textarea id="step3PagePromptOutput_${i}" readonly></textarea>
                    <button id="copyTextPrompt_page_${i}" class="button-secondary" data-page="${i}">Copier Prompt Texte</button>
                    
                    <label for="pageAiDetailedResponse_${i}">Coller la description DÉTAILLÉE Textuelle de la ${unitName.toLowerCase()} ${i} (générée par l'IA) :</label>
                    <textarea id="pageAiDetailedResponse_${i}"></textarea> 
                    
                    <div class="storyboard-page-section">
                        <h5>Storyboard pour ${unitName} ${i}</h5>
                        <button id="generateStoryboardPrompt_page_${i}" data-page="${i}" class="button-tertiary">Générer Prompt Storyboard pour cette ${unitName}</button>
                        <label for="storyboardPromptOutput_page_${i}">Prompt Storyboard pour ${unitName} ${i} :</label>
                        <textarea id="storyboardPromptOutput_page_${i}" readonly></textarea>
                        <button id="copyStoryboardPrompt_page_${i}" class="button-secondary" data-page="${i}">Copier Prompt Storyboard</button>
                        <label for="storyboardAiOutput_page_${i}">Coller le code HTML/SVG pour ${unitName} ${i} ici :</label>
                        <textarea id="storyboardAiOutput_page_${i}" style="font-family: monospace;"></textarea>
                        </div>
                `;
                step3PagePromptsContainer.appendChild(pageBlock);
                
                document.getElementById(`generateTextPrompt_page_${i}`).addEventListener('click', handleGenerateDetailedTextPromptForPage);
                document.getElementById(`copyTextPrompt_page_${i}`).addEventListener('click', (e) => copyToClipboard(`step3PagePromptOutput_${e.target.dataset.page}`));
                
                document.getElementById(`generateStoryboardPrompt_page_${i}`).addEventListener('click', handleGenerateStoryboardPromptForPage);
                document.getElementById(`copyStoryboardPrompt_page_${i}`).addEventListener('click', (e) => copyToClipboard(`storyboardPromptOutput_page_${e.target.dataset.page}`));
                // L'écouteur pour le bouton de prévisualisation a été retiré
            }
            if (totalPages > 0) { showToastNotification(`${totalPages} bloc(s) pour l'Étape 3 ont été générés.`); }
        });

        function handleGenerateDetailedTextPromptForPage(event) {
            const pageNum = parseInt(event.target.dataset.page, 10);
            const titreEtDescriptionBD = step1AiResponse.value.trim();
            const descriptionDeChaquePage = step2AiResponse.value.trim(); 
            const currentNomBdForUnit = nomBdInput.value;
            const totalPagesForUnit = parseInt(totalPagesInput.value, 10);
            let unitName = (currentNomBdForUnit.toLowerCase().includes("gag-strip") || (currentNomBdForUnit.toLowerCase().includes("gag 1p.") && totalPagesForUnit === 1 && !currentNomBdForUnit.toLowerCase().includes("petit spirou")) ) ? "strip" : "page";

            if (!titreEtDescriptionBD) { showToastNotification("Veuillez coller le résultat de l'IA de l'Étape 1."); return; }
            if (!descriptionDeChaquePage) { showToastNotification("Veuillez coller le résultat de l'IA de l'Étape 2."); return; }
            
            let prevPageDescriptionRef = "";
            if (pageNum > 1) {
                const prevPageTextResponseTextarea = document.getElementById(`pageAiDetailedResponse_${pageNum - 1}`); 
                if (prevPageTextResponseTextarea && prevPageTextResponseTextarea.value.trim() !== "") {
                    prevPageDescriptionRef = `\nVoici la description détaillée du/de la ${unitName} précédente comme référence :\n--- DÉBUT DESCRIPTION ${unitName.toUpperCase()} PRÉCÉDENTE ---\n"${prevPageTextResponseTextarea.value.trim()}"\n--- FIN DESCRIPTION ${unitName.toUpperCase()} PRÉCÉDENTE ---`;
                } else { showToastNotification(`Info: La description textuelle détaillée de la ${unitName} ${pageNum - 1} n'a pas été fournie pour référence pour le prompt texte.`); }
            }

            const currentNomBd = nomBdInput.value;
            const totalPagesForGagCheck = parseInt(totalPagesInput.value, 10);
            let endingDescriptionDetail = "une conclusion satisfaisante (par exemple, la fin d'un arc narratif, la résolution d'un combat important, ou un cliffhanger pour le prochain chapitre/la prochaine histoire).";
            if (currentNomBd.toLowerCase().includes("gag") || totalPagesForGagCheck <= 2) {
                endingDescriptionDetail = `une "punch line" mémorable – un dénouement surprenant, très drôle, et d'une nature délicieusement absurde ou inusitée.`;
            }
            
            const prompt = `Considérant cette oeuvre (album/histoire/gag/strip/chapitre manga/arc manga/aventure) suivante:
--- DÉBUT TITRE ET DESCRIPTION BD ---
${titreEtDescriptionBD}
--- FIN TITRE ET DESCRIPTION BD ---

Et la description sommaire de chaque ${unitName} (générée à l'étape précédente):
--- DÉBUT DESCRIPTION SOMMAIRE DES ${unitName.toUpperCase()}S ---
${descriptionDeChaquePage}
--- FIN DESCRIPTION SOMMAIRE DES ${unitName.toUpperCase()}S ---

Générez-moi la description détaillée TEXTUELLE du/de la ${unitName} ${pageNum}.${prevPageDescriptionRef}
La description détaillée doit contenir chaque case du/de la ${unitName} avec les dialogues (sauf si c'est un gag muet où les descriptions indiqueront 0 bulles/mots) et une description schématique simple des dessins. Pour un manga, veuillez inclure des suggestions d'onomatopées (effets sonores) pertinentes et décrire le dynamisme attendu des cases, surtout pour les scènes d'action.
La description détaillée doit pouvoir servir de prompt pour un générateur d'images par intelligence artificielle.
Assurez-vous de respecter le ton, le style, les personnages définis et la structure du/de la ${unitName} (nombre de cases, etc.) qui ont été établis précédemment pour cette oeuvre.
Si la description sommaire des ${unitName}s (issue de l'étape 2) indique un effet intriguant pour ce(tte) ${unitName} ${pageNum} (et si ce n'est pas le/la dernier/dernière ${unitName} de l'oeuvre et qu'elle a plusieurs ${unitName}s), assurez-vous que la description détaillée du/de la ${unitName} se termine par cet effet.
Si c'est le/la dernier/dernière ${unitName} de l'oeuvre (selon les descriptions de l'étape 2), assurez ${endingDescriptionDetail}`;
            document.getElementById(`step3PagePromptOutput_${pageNum}`).value = prompt; 
            showToastNotification(`Prompt pour texte détaillé de la ${unitName} ${pageNum} généré.`);
        }

        function handleGenerateStoryboardPromptForPage(event) { // Pour Étape 3 storyboard par page
            const pageNum = parseInt(event.target.dataset.page, 10);
            const detailedTextForPage = document.getElementById(`pageAiDetailedResponse_${pageNum}`).value.trim();

            if (!detailedTextForPage) {
                showToastNotification(`Veuillez d'abord coller la description textuelle détaillée pour la ${getUnitName()} ${pageNum}.`);
                return;
            }
            
            const nomDeLaBd = nomBdInput.value.trim() || "[Nom de BD non spécifié]";
            const totalPages = parseInt(totalPagesInput.value, 10);
            const panelsPerPage = panelsPerPageInput.value;
            let unitName = getUnitName();
            let typeOeuvre = getTypeOeuvre();


            let mangaSpecificsForStoryboard = "";
            if (["naruto", "one piece", "attack on titan", "death note", "berserk", "spy x family", "dr. slump", "astro boy", "dragon ball", "dragon ball z"].some(m => nomDeLaBd.toLowerCase().includes(m.replace(/\s/g, ''))) ) { 
                mangaSpecificsForStoryboard = "Pour un manga, pensez aux onomatopées SVG (peut être du texte stylisé) et à la dynamique des cases.";
            }

            const storyboardPrompt = `
Vous êtes un assistant expert en création de storyboards VISUELS pour bandes dessinées au format HTML et SVG, à partir de descriptions textuelles détaillées.

TÂCHE : Convertir la description détaillée de la ${unitName} NUMÉRO ${pageNum} de l'oeuvre "${nomDeLaBd}" (type "${typeOeuvre}") fournie ci-dessous en un **DOCUMENT HTML COMPLET ET AUTONOME** contenant le storyboard pour cette SEULE ${unitName}.

DESCRIPTION DÉTAILLÉE DE LA ${unitName.toUpperCase()} ${pageNum} À CONVERTIR :
--- DÉBUT DESCRIPTION ${unitName.toUpperCase()} ${pageNum} ---
${detailedTextForPage}
--- FIN DESCRIPTION ${unitName.toUpperCase()} ${pageNum} ---

PARAMÈTRES GÉNÉRAUX DE L'OEUVRE (pour contexte, la description ci-dessus est prioritaire pour le contenu de CETTE ${unitName}) :
- Nom de l'oeuvre / Série : ${nomDeLaBd}
- Cases par ${unitName} (moyenne indicative globale, la description détaillée de la ${unitName} ${pageNum} doit être suivie pour le nombre exact de cases) : ${panelsPerPage}

INSTRUCTIONS POUR LA GÉNÉRATION DU DOCUMENT HTML/SVG DE CETTE ${unitName.toUpperCase()} UNIQUE :
1.  **Format de Sortie :** Le résultat doit être un document HTML5 valide et complet, commençant par \`<!DOCTYPE html>\` et se terminant par \`</html>\`.
2.  **Structure du Document :**
    * Incluez une balise \`<head>\` avec un \`<title>\` approprié (ex: "Storyboard - ${nomDeLaBd} - ${unitName.charAt(0).toUpperCase() + unitName.slice(1)} ${pageNum}") et les styles CSS fournis ci-dessous dans une balise \`<style>\`.
    * Le \`<body>\` doit contenir un \`<h1>\` avec le titre de la ${unitName} (ex: "${nomDeLaBd} - ${unitName.charAt(0).toUpperCase() + unitName.slice(1)} ${pageNum}").
    * Ensuite, un SEUL \`<div class="comic-page" id="page_${pageNum}_storyboard_content">\` représentant la ${unitName} demandée.
    * Dans ce \`div\`, incluez un résumé en une phrase de cette ${unitName} (que vous synthétiserez à partir de la description détaillée fournie) dans un \`<h5>\`.
    * Organisez les cases à l'intérieur en utilisant une \`<div class="panel-grid">\`.
3.  **Structure par Case :**
    * Chaque case décrite dans le texte source doit être un \`<div class="panel-container">\`.
    * Au début de chaque \`<div class="panel-container">\`, incluez un titre \`<h6>\` contenant "Case [Numéro de la case dans CETTE ${unitName}] : [Synthétisez ici un résumé en 1 phrase de cette case à partir de sa description]". Le numéro de case est séquentiel pour CETTE ${unitName}.
    * Dans chaque \`<div class="panel-container">\`, insérez un élément \`<svg class="panel-svg" viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg">\`.
4.  **Contenu SVG Schématique pour chaque case :**
    * **INTERPRÉTEZ** la "Description Visuelle" et les "Dialogues/Texte" fournis pour chaque case dans la description détaillée.
    * **Dessins :** Formes SVG SIMPLES (\`<rect>\`, \`<circle>\`, \`<line>\`, etc.). Personnages schématiques (tête-cercle, corps-ligne/rectangle).
    * **Dialogues/Narration :** Intégrez les textes dans des bulles SVG ou rectangles SVG. Utilisez \`<text>\` avec des attributs x, y pour la position.
    * **Positionnement :** Positionnez logiquement les éléments SVG (personnages, objets, bulles, narration) dans chaque case.
    * ${mangaSpecificsForStoryboard}
5.  **Code Source Brut :** N'ÉCHAPPEZ PAS les caractères HTML (\`<\`, \`>\`).

UTILISEZ LE TEMPLATE HTML/SVG SUIVANT COMME STRUCTURE DE BASE POUR VOTRE SORTIE (en remplaçant les placeholders et en générant le contenu SVG) :
\`\`\`html
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Storyboard - ${nomDeLaBd} - ${unitName.charAt(0).toUpperCase() + unitName.slice(1)} ${pageNum}</title>
    <style>
        body { font-family: sans-serif; margin: 10px; background-color: #e9e9e9; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .comic-page { border: 2px solid #999; padding: 15px; background-color: #fff; box-shadow: 3px 3px 5px #ccc; width: 90%; max-width: 800px; margin: 0 auto; }
        .comic-page-summary { font-style: italic; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .panel-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .panel-container { border: 1px solid #ccc; margin-bottom: 15px; padding: 10px; background-color: #f9f9f9; flex: 1 1 calc(33.333% - 20px); box-sizing: border-box; min-width: 250px; max-width: 300px; display: flex; flex-direction: column;}
        .panel-summary { font-size: 0.9em; color: #333; margin-bottom: 5px; }
        .panel-svg { border: 1px solid black; width: 100%; height: auto; aspect-ratio: 4/3; background-color: white; }
        svg text { font-family: "Comic Sans MS", "Arial Narrow", sans-serif; } 
        .speech-bubble-path { fill: white; stroke: black; stroke-width: 1.5; }
        .speech-bubble-text { text-anchor: middle; dominant-baseline: middle; font-size: 10px; fill: black; }
        .narrative-box-path { fill: #FFFACD; stroke: #F0E68C; stroke-width: 1; }
        .narrative-text { font-size: 9px; font-style: italic; fill: black; }
    </style>
</head>
<body>
    <h1>Storyboard pour ${nomDeLaBd} - ${unitName.charAt(0).toUpperCase() + unitName.slice(1)} ${pageNum}</h1>
    
    <div class="comic-page" id="page_${pageNum}_storyboard_content">
        <h5>${unitName.charAt(0).toUpperCase() + unitName.slice(1)} ${pageNum} : [Synthétisez ici un résumé en 1 phrase de la ${unitName} à partir de la description fournie]</h5>
        <div class="panel-grid">
            <div class="panel-container" id="page_${pageNum}_panel_[Numéro_de_case]">
                <h6>Case [Numéro_de_case] : [Résumé en 1 ligne de cette case spécifique]</h6>
                <svg class="panel-svg" viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg">
                    [Générez ici le contenu SVG pour CETTE case : personnages schématiques, objets clés, arrière-plans simples, bulles avec dialogues, blocs narratifs avec texte. Soyez précis avec les coordonnées (x, y, etc.) et les dimensions pour la mise en page. ${mangaSpecificsForStoryboard}]
                </svg>
            </div>
            </div>
    </div>
</body>
</html>
\`\`\`
`;
            document.getElementById(`storyboardPromptOutput_page_${pageNum}`).value = storyboardPrompt.trim();
            showToastNotification(`Prompt Storyboard pour ${unitName} ${pageNum} généré.`);
        }

        // Fonction handlePreviewPageStoryboard supprimée

        compileAllContentBtn.addEventListener('click', function() {
            let fullCompilation = [];
            const totalPages = parseInt(totalPagesInput.value, 10); 
            const currentNomBd = nomBdInput.value;
            let unitName = (currentNomBd.toLowerCase().includes("gag-strip") || (currentNomBd.toLowerCase().includes("gag 1p.") && totalPages === 1 && !currentNomBd.toLowerCase().includes("petit spirou")) ) ? "STRIP" : "PAGE";

            const etape1Content = step1AiResponse.value.trim();
            if (etape1Content) { fullCompilation.push("=== ÉTAPE 1 : DÉFINITION DE L'OEUVRE ==="); fullCompilation.push(etape1Content);
            } else { showToastNotification("Contenu de l'Étape 1 manquant pour la compilation."); }

            const etape2Content = step2AiResponse.value.trim();
            if (etape2Content) { fullCompilation.push(`\n\n=== ÉTAPE 2 : STRUCTURE DES ${unitName}S (DESCRIPTIONS SOMMAIRES) ===`); fullCompilation.push(etape2Content);
            } else { showToastNotification("Contenu de l'Étape 2 manquant pour la compilation."); }
            
            if (!isNaN(totalPages) && totalPages > 0) {
                let allPagesDetailCollectedOrMarked = true; 
                let step3Content = [];
                for (let i = 1; i <= totalPages; i++) {
                    const pageDetailTextarea = document.getElementById(`pageAiDetailedResponse_${i}`);
                    if (pageDetailTextarea) { 
                        if (pageDetailTextarea.value.trim()) {
                            step3Content.push(`\n--- ${unitName} ${i} ---`); step3Content.push(pageDetailTextarea.value.trim());
                        } else {
                            step3Content.push(`\n--- ${unitName} ${i} ---`); step3Content.push(`[Description détaillée pour ce(tte) ${unitName.toLowerCase()} non fournie]`);
                            allPagesDetailCollectedOrMarked = false; 
                        }
                    } else { 
                        step3Content.push(`\n--- ${unitName} ${i} ---`); step3Content.push(`[Champs pour ${unitName.toLowerCase()} ${i} non générés/trouvés]`);
                        allPagesDetailCollectedOrMarked = false;
                    }
                }
                if (step3Content.length > 0){ fullCompilation.push(`\n\n=== ÉTAPE 3 : DESCRIPTIONS DÉTAILLÉES DES ${unitName}S ===`); fullCompilation.push(step3Content.join("\n")); 
                } else if (totalPages > 0) { 
                     fullCompilation.push(`\n\n=== ÉTAPE 3 : DESCRIPTIONS DÉTAILLÉES DES ${unitName}S ===`);
                     fullCompilation.push(`[Aucune description détaillée de ${unitName.toLowerCase()} n'a été fournie pour les ${totalPages} ${unitName.toLowerCase()}(s) de base.]`);
                }
                 if (!allPagesDetailCollectedOrMarked && step3Content.length > 0) { 
                    showToastNotification(`Certaines descriptions détaillées de ${unitName.toLowerCase()} de l'Étape 3 sont manquantes ou non générées.`);
                }
            } else { showToastNotification("Nombre de pages (base) non défini ou invalide pour compiler l'Étape 3."); }
            
            finalCompilationOutput.value = fullCompilation.join("\n"); 
            if(fullCompilation.length > 0 && (etape1Content || etape2Content || (!isNaN(totalPages) && totalPages > 0) ) ) {
                showToastNotification("Compilation textuelle terminée !");
            } else { showToastNotification("Rien à compiler pour le moment."); }
        });
        copyFinalCompilationBtn.addEventListener('click', () => {
            if (finalCompilationOutput.value.trim() === "") { showToastNotification("Rien à copier, la compilation est vide."); return; }
            copyToClipboard('finalCompilationOutput');
        });
        
        // --- Logique pour Mode Monobloc (Texte) ---
        generateSingleBlockTextPromptBtn.addEventListener('click', function() { // Renommé pour clarté
            const nomDeLaBd = nomBdInput.value.trim() || "[À DÉFINIR PAR L'IA]";
            const totalPages = parseInt(totalPagesInput.value, 10);
            const variation = parseInt(pageVariationInput.value, 10);
            const panelsPerPage = panelsPerPageInput.value;
            const bubblesPerPage = bubblesPerPageInput.value;
            const wordsPerPage = wordsPerPageInput.value;
            const yellowBlocksPerPage = yellowBlocksPerPageInput.value;

            if (isNaN(totalPages) || totalPages <= 0) {
                showToastNotification("Veuillez définir un nombre de pages (base) valide pour le prompt unique.");
                return;
            }

            let typeOeuvre = getTypeOeuvre(); // Utilisation de la fonction helper
            let unitName = getUnitName();   // Utilisation de la fonction helper

            let pageCountDetails = "";
            if (variation === 0) {
                pageCountDetails = `${totalPages} ${unitName}${totalPages > 1 ? 's' : ''} (nombre fixe).`;
            } else {
                const minPages = Math.max(1, totalPages - variation);
                const maxPages = totalPages + variation;
                pageCountDetails = `environ ${totalPages} ${unitName}${totalPages > 1 ? 's' : ''}, pouvant varier de ${minPages} à ${maxPages}.`;
            }

            let endingType = "une conclusion satisfaisante (par exemple, la fin d'un arc narratif, la résolution d'un combat important, ou un cliffhanger pour le prochain chapitre/la prochaine histoire).";
            if (nomDeLaBd.toLowerCase().includes("gag") || totalPages <= 2) {
                endingType = `une "punch line" – un dénouement surprenant, très drôle, et d'une nature délicieusement absurde ou inusitée.`;
            }
            
            let mangaSpecifics = "";
            if (typeOeuvre.includes("manga") || nomDeLaBd.toLowerCase().includes("chapitre") || nomDeLaBd.toLowerCase().includes("arc") || ["naruto", "one piece", "attack on titan", "death note", "berserk", "spy x family", "dr. slump", "astro boy", "dragon ball", "dragon ball z"].some(m => nomDeLaBd.toLowerCase().includes(m.replace(/\s/g, '')))) { 
                mangaSpecifics = "\n    - Pour un manga, inclure des suggestions d'onomatopées (effets sonores) et décrire le dynamisme des cases, surtout pour l'action.";
            }

            const globalPrompt = `
Vous êtes un assistant expert en création de scénarios et de storyboards pour bandes dessinées.
Votre tâche est de générer une oeuvre complète de type "${typeOeuvre}" dans l'univers de "${nomDeLaBd}".

PARAMÈTRES GÉNÉRAUX DE L'OEUVRE FOURNIS À TITRE INDICATIF (L'IA DEVRA DÉFINIR LES SPÉCIFICITÉS PAR ${unitName.toUpperCase()} DANS LA PARTIE B ET S'Y TENIR) :
- Longueur de base attendue : ${totalPages} ${unitName}${totalPages > 1 ? 's' : ''}.
- Variation autorisée : +/- ${variation} ${unitName}${totalPages > 1 ? 's' : ''}. (Le nombre total de ${unitName}s de l'oeuvre générée doit se situer dans cette fourchette).
- Cases par ${unitName} (moyenne indicative globale) : ${panelsPerPage}
- Bulles par ${unitName} (moyenne indicative globale) : ${bubblesPerPage}
- Mots par ${unitName} (moyenne indicative globale) : ${wordsPerPage}
- Blocs narratifs/explicatifs par ${unitName} (moyenne indicative globale) : ${yellowBlocksPerPage}

VEUILLEZ FOURNIR LES INFORMATIONS SUIVANTES DANS L'ORDRE ET AVEC LA STRUCTURE DÉTAILLÉE CI-DESSOUS :

### PARTIE A : DÉFINITION GLOBALE DE L'OEUVRE
1.  **TITRE DE L'OEUVRE :**
    [Proposez un titre original et adapté]
2.  **RÉSUMÉ DE L'INTRIGUE PRINCIPALE :**
    (1-2 phrases pour un gag/strip, 3-5 pour une histoire courte ou un chapitre, potentiellement plus pour un arc narratif ou une aventure complète. Décrivez le concept central, les enjeux et la direction générale de l'intrigue.)
3.  **PERSONNAGES IMPORTANTS :**
    (Listez les personnages clés de cette oeuvre spécifique, y compris les nouveaux si pertinent, et décrivez brièvement leur rôle ou leur objectif dans cette intrigue.)
4.  **TON ET STYLE :**
    (Décrivez le ton général (humoristique, aventureux, dramatique, etc.) et le style graphique/narratif à adopter pour cette oeuvre, en respectant l'univers de "${nomDeLaBd}".)
5.  **ORIGINALITÉ ET RESPECT DE L'UNIVERS :**
    L'oeuvre générée doit être une création originale, évitant de reproduire trop fidèlement des oeuvres existantes, tout en restant cohérente avec l'esprit, les thèmes et les personnages de l'univers de "${nomDeLaBd}".

### PARTIE B : STRUCTURE DÉTAILLÉE ET RÉSUMÉS DES ${unitName.toUpperCase()}S
1.  **NOMBRE TOTAL DE ${unitName.toUpperCase()}S EFFECTIVEMENT UTILISÉES DANS VOTRE GÉNÉRATION :**
    [Indiquez ici le nombre exact de ${unitName}s que vous allez décrire ci-dessous, en respectant la variation autorisée autour de ${totalPages} ${unitName}s.]
2.  **POUR CHAQUE ${unitName.toUpperCase()}** (du/de la ${unitName} 1 au/à la ${unitName} [Nombre total de ${unitName}s utilisées]) :

    **${unitName.charAt(0).toUpperCase() + unitName.slice(1)} [Numéro]**
    * **Résumé Sommaire :** (1-3 lignes maximum. Décrivez l'action principale et le contenu essentiel. Assurez un effet intriguant à la fin (sauf la dernière, ou pour un gag en une seule unité) qui donne envie de lire la suite, et dont la mini-intrigue sera résolue ensuite.)
    * **Spécifications pour CETTE UNITÉ (${unitName.toUpperCase()}) :** (Ces valeurs doivent être respectées dans la PARTIE C)
        * Nombre de cases prévues : [Nombre exact]
        * Nombre de bulles prévues (approximatif) : [Nombre]
        * Nombre de mots prévus (approximatif) : [Nombre]
        * Nombre de blocs narratifs/explicatifs prévus : [Nombre]

    *(Rappel : La dernière unité (${unitName}) doit se terminer par ${endingType})*

### PARTIE C : DESCRIPTION DÉTAILLÉE DE CHAQUE ${unitName.toUpperCase()} ET DE CHAQUE CASE
**POUR CHAQUE ${unitName.toUpperCase()}** (décrite dans la PARTIE B, du/de la ${unitName} 1 au/à la ${unitName} [Nombre total de ${unitName}s utilisées]) :

**-------------------- DÉBUT ${unitName.toUpperCase()} [Numéro] --------------------**
*(Rappel du Résumé Sommaire de la ${unitName.toUpperCase()} [Numéro] ici)*

**POUR CHAQUE CASE** (de 1 au nombre de cases défini pour CETTE UNITÉ (${unitName.toUpperCase()}) DANS LA PARTIE B) :

**Case [Numéro de la case] :**
* **Description Visuelle :** (Description schématique simple et claire du dessin : personnages, actions, expressions, décor, cadrage, angles. ${mangaSpecifics})
* **Dialogues/Texte :** (Texte exact des bulles, pensées, ou blocs narratifs DANS cette case. Si muet, indiquer "Aucun dialogue".)

**-------------------- FIN ${unitName.toUpperCase()} [Numéro] --------------------**

NOTES IMPORTANTES POUR VOTRE GÉNÉRATION :
-   **Cohérence et Continuité :** Assurez une parfaite continuité narrative, logique et visuelle.
-   **Respect des Instructions :** Suivez scrupuleusement le ton, le style, les personnages de l'univers "${nomDeLaBd}", ainsi que les paramètres généraux (moyennes indicatives globales) ET SURTOUT les spécifications (nombre de cases, bulles, mots, blocs narratifs) que VOUS AVEZ DÉFINIES pour chaque ${unitName} dans la PARTIE B lors de la génération de la PARTIE C.
-   **Clarté pour Générateur d'Images :** La "Description Visuelle" de chaque case doit être formulée de manière à pouvoir servir de prompt efficace pour un générateur d'images par IA.
-   **Format de Sortie :** Veuillez utiliser la structure de titres et listes (comme "### PARTIE A", "1. TITRE", "**${unitName.charAt(0).toUpperCase() + unitName.slice(1)} [X]**", "**Case [Y] :**") pour faciliter la lecture de votre réponse.

INSTRUCTION IMPORTANTE CONCERNANT LA LONGUEUR DE LA RÉPONSE POUR LA PARTIE C :
La description détaillée de toutes les ${unitName}s (PARTIE C) peut s'avérer très longue, en particulier pour les œuvres comptant de nombreuses ${unitName}s.
Si vous ne parvenez pas à générer l'intégralité de la PARTIE C en une seule réponse en raison de limitations de longueur :
1.  Veuillez générer autant de ${unitName}s complètes que possible dans votre réponse actuelle.
2.  À la fin de votre réponse, veuillez indiquer clairement jusqu'à quelle ${unitName} vous avez fourni la description détaillée (par exemple : "Description détaillée fournie jusqu'à la ${unitName} X sur Y.").
3.  Soyez prêt à continuer la génération des ${unitName}s suivantes si l'utilisateur vous envoie simplement le message : "Continuez". Vous reprendrez alors exactement où vous vous êtes arrêté.
`;
            singleBlockTextPromptOutput.value = globalPrompt.trim();
            showToastNotification("Prompt unique global (texte) généré !");
        });
        copySingleBlockTextPromptBtn.addEventListener('click', () => copyToClipboard('singleBlockTextPromptOutput'));
        
        // --- Logique pour la conversion en storyboard depuis le Mode Monobloc (si 1 page) ---
        generateSinglePageStoryboardPromptFromMonoblocBtn.addEventListener('click', function() {
            const singleBlockText = singleBlockAiTextOutput.value.trim();
            if (!singleBlockText) {
                showToastNotification("Veuillez d'abord coller la sortie textuelle complète du Mode Monobloc.");
                return;
            }
            const totalPages = parseInt(totalPagesInput.value, 10);
            if (totalPages !== 1) { // Sécurité, même si le bouton est conditionnel
                showToastNotification("Cette option de storyboard n'est prévue que pour les sorties monobloc d'une seule page/strip.");
                return;
            }

            // Réutiliser la logique de handleGenerateStoryboardPromptForPage, en adaptant la source du texte
            const nomDeLaBd = nomBdInput.value.trim() || "[Nom de BD non spécifié]";
            const panelsPerPage = panelsPerPageInput.value; // Contexte
            let unitName = getUnitName();
            let typeOeuvre = getTypeOeuvre();
            let mangaSpecificsForStoryboard = getMangaSpecifics();
            
            // Pour le prompt du storyboard d'une page unique, le "pageNum" est toujours 1.
            // Le detailedTextForPage est la totalité de singleBlockAiTextOutput,
            // car on assume que ce texte décrit une seule page/strip.
            // L'IA devra extraire les infos de case de ce bloc de texte.
            const storyboardPrompt = `
Vous êtes un assistant expert en création de storyboards VISUELS pour bandes dessinées au format HTML et SVG, à partir de descriptions textuelles détaillées.

TÂCHE : Convertir la description détaillée de la ${unitName} unique (Page/Strip 1) de l'oeuvre "${nomDeLaBd}" (type "${typeOeuvre}") fournie ci-dessous en un **DOCUMENT HTML COMPLET ET AUTONOME** contenant le storyboard pour cette SEULE ${unitName}. La description fournie est le résultat complet d'un prompt précédent et contient la définition de l'oeuvre (PARTIE A), la structure (PARTIE B pour une seule ${unitName}), et la description détaillée des cases (PARTIE C pour cette ${unitName}).

DESCRIPTION COMPLÈTE DE L'OEUVRE (1 ${unitName.toUpperCase()}) À CONVERTIR :
--- DÉBUT DESCRIPTION DE L'OEUVRE ---
${singleBlockText}
--- FIN DESCRIPTION DE L'OEUVRE ---

PARAMÈTRES GÉNÉRAUX DE L'OEUVRE (pour contexte, la description ci-dessus est prioritaire pour le contenu de CETTE ${unitName}) :
- Nom de l'oeuvre / Série : ${nomDeLaBd}
- Cases par ${unitName} (moyenne indicative globale, la description de la ${unitName} doit être suivie pour le nombre exact de cases) : ${panelsPerPage}

INSTRUCTIONS POUR LA GÉNÉRATION DU DOCUMENT HTML/SVG DE CETTE ${unitName.toUpperCase()} UNIQUE :
1.  **Format de Sortie :** Le résultat doit être un document HTML5 valide et complet, commençant par \`<!DOCTYPE html>\` et se terminant par \`</html>\`.
2.  **Extraction d'Informations :** Depuis la "DESCRIPTION COMPLÈTE DE L'OEUVRE" :
    * Extrayez le **Titre de l'oeuvre** de la PARTIE A.
    * Créez un **Résumé Sommaire de la ${unitName}** (1 phrase) en vous basant sur la PARTIE B (s'il y a une section pour ${unitName} 1) ou la PARTIE C.
    * Déterminez le **Nombre de cases** pour cette ${unitName} à partir de la PARTIE B ou en comptant les descriptions de cases dans la PARTIE C.
3.  **Structure du Document :** (Identique au prompt pour la page unique de l'Étape 3)
    * Incluez une balise \`<head>\` avec un \`<title>\` (ex: "Storyboard - ${nomDeLaBd} - ${unitName.charAt(0).toUpperCase() + unitName.slice(1)} 1") et les styles CSS fournis ci-dessous dans une balise \`<style>\`.
    * Le \`<body>\` doit contenir un \`<h1>\` avec le titre (ex: "${nomDeLaBd} - ${unitName.charAt(0).toUpperCase() + unitName.slice(1)} 1").
    * Ensuite, un SEUL \`<div class="comic-page" id="page_1_storyboard_content">\`.
    * Dans ce \`div\`, incluez le résumé de la ${unitName} dans un \`<h5>\` et une \`<div class="panel-grid">\` pour les cases.
4.  **Structure par Case :** (Identique)
5.  **Contenu SVG Schématique :** (Identique, basé sur la PARTIE C de la description fournie)
    ${mangaSpecificsForStoryboard}
6.  **Code Source Brut :** N'ÉCHAPPEZ PAS les caractères HTML.

UTILISEZ LE TEMPLATE HTML/SVG SUIVANT COMME STRUCTURE DE BASE POUR VOTRE SORTIE (en remplaçant les placeholders et en générant le contenu SVG) :
\`\`\`html
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Storyboard - ${nomDeLaBd} - ${unitName.charAt(0).toUpperCase() + unitName.slice(1)} 1</title>
    <style>
        body { font-family: sans-serif; margin: 10px; background-color: #e9e9e9; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .comic-page { border: 2px solid #999; padding: 15px; background-color: #fff; box-shadow: 3px 3px 5px #ccc; width: 90%; max-width: 800px; margin: 0 auto; }
        .comic-page-summary { font-style: italic; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .panel-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .panel-container { border: 1px solid #ccc; margin-bottom: 15px; padding: 10px; background-color: #f9f9f9; flex: 1 1 calc(33.333% - 20px); box-sizing: border-box; min-width: 250px; max-width: 300px; display: flex; flex-direction: column;}
        .panel-summary { font-size: 0.9em; color: #333; margin-bottom: 5px; }
        .panel-svg { border: 1px solid black; width: 100%; height: auto; aspect-ratio: 4/3; background-color: white; }
        svg text { font-family: "Comic Sans MS", "Arial Narrow", sans-serif; } 
        .speech-bubble-path { fill: white; stroke: black; stroke-width: 1.5; }
        .speech-bubble-text { text-anchor: middle; dominant-baseline: middle; font-size: 10px; fill: black; }
        .narrative-box-path { fill: #FFFACD; stroke: #F0E68C; stroke-width: 1; }
        .narrative-text { font-size: 9px; font-style: italic; fill: black; }
    </style>
</head>
<body>
    <h1>Storyboard pour ${nomDeLaBd} - ${unitName.charAt(0).toUpperCase() + unitName.slice(1)} 1</h1>
    
    <div class="comic-page" id="page_1_storyboard_content">
        <h5>${unitName.charAt(0).toUpperCase() + unitName.slice(1)} 1 : [Synthétisez ici un résumé en 1 phrase de la ${unitName} à partir de la description fournie]</h5>
        <div class="panel-grid">
            <div class="panel-container" id="page_1_panel_[Numéro_de_case]">
                <h6>Case [Numéro_de_case] : [Résumé en 1 ligne de cette case spécifique]</h6>
                <svg class="panel-svg" viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg">
                    [Générez ici le contenu SVG pour CETTE case en interprétant la PARTIE C de la description fournie pour cette ${unitName} unique.]
                </svg>
            </div>
            </div>
    </div>
</body>
</html>
\`\`\`
`;
            singlePageStoryboardConversionPromptOutput.value = storyboardPrompt.trim();
            showToastNotification("Prompt pour storyboard de la page unique (Mode Monobloc) généré !");
        });
        copySinglePageStoryboardConversionPromptBtn.addEventListener('click', () => copyToClipboard('singlePageStoryboardConversionPromptOutput'));


        // Helper functions pour déterminer typeOeuvre et unitName
        function getTypeOeuvre() {
            const nomDeLaBd = nomBdInput.value.trim();
            const currentTotalPages = parseInt(totalPagesInput.value, 10);
            let typeOeuvre = "d'un album"; 
            if (nomDeLaBd.toLowerCase().includes("gag-strip") || (nomDeLaBd.toLowerCase().includes("gag 1p.") && currentTotalPages === 1 && !nomDeLaBd.toLowerCase().includes("petit spirou")) ) { typeOeuvre = "d'un gag (format strip)"; }
            else if (nomDeLaBd.toLowerCase().includes("gag")) { typeOeuvre = "d'un gag"; } 
            else if (nomDeLaBd.toLowerCase().includes("hist.")) { typeOeuvre = "d'une histoire courte"; } 
            else if (nomDeLaBd.toLowerCase().includes("histoire")) { typeOeuvre = "d'une histoire"; } 
            else if (nomDeLaBd.toLowerCase().includes("aventure jeunesse")) { typeOeuvre = "d'une aventure jeunesse"; }
            else if (nomDeLaBd.toLowerCase().includes("aventure")) { typeOeuvre = "d'une aventure"; }
            else if (nomDeLaBd.toLowerCase().includes("(bd québécoise)")) { typeOeuvre = "d'une bande dessinée (style américain, adaptation québécoise)"; } 
            else if (nomDeLaBd.toLowerCase().includes("(chapitre") || nomDeLaBd.toLowerCase().includes("(arc")) { 
                 if (nomDeLaBd.toLowerCase().includes("arc") || (!isNaN(currentTotalPages) && currentTotalPages > 50)) {
                    typeOeuvre = "d'un arc narratif (type manga)";
                } else {
                    typeOeuvre = "d'un chapitre (type manga)";
                }
            }
            return typeOeuvre;
        }

        function getUnitName() {
            const nomDeLaBd = nomBdInput.value.trim();
            const totalPages = parseInt(totalPagesInput.value, 10);
            return (nomDeLaBd.toLowerCase().includes("gag-strip") || (nomDeLaBd.toLowerCase().includes("gag 1p.") && totalPages === 1 && !nomDeLaBd.toLowerCase().includes("petit spirou")) ) ? "strip" : "page";
        }
        
        function getMangaSpecifics() {
            const nomDeLaBd = nomBdInput.value.trim();
            let typeOeuvre = getTypeOeuvre(); // Utiliser la fonction helper
            if (typeOeuvre.includes("manga") || nomDeLaBd.toLowerCase().includes("chapitre") || nomDeLaBd.toLowerCase().includes("arc") || ["naruto", "one piece", "attack on titan", "death note", "berserk", "spy x family", "dr. slump", "astro boy", "dragon ball", "dragon ball z"].some(m => nomDeLaBd.toLowerCase().includes(m.replace(/\s/g, '')))) { 
                return "\n    - Pour un manga, inclure des suggestions d'onomatopées (effets sonores) et décrire le dynamisme des cases, surtout pour l'action.";
            }
            return "";
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            populatePresetDropdown(); 
            setDefaultParameters(); 
            switchMode('stepByStep'); 
        });

    </script>
</body>
</html>